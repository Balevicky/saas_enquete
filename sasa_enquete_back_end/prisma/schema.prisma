generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id           String        @id @default(cuid())
  name         String
  slug         String        @unique
  logoUrl      String?
  settings     Json?
  invites      Invite[]
  surveys      Survey[]
  users        UserTenant[]
  // Relations inverses obligatoires
  regions      Region[]
  departements Departement[]
  secteurs     Secteur[]
  villages     Village[]
  passwordResetTokens   PasswordResetToken[]
  createdAt DateTime @default(now())
}

model User {
  id        String       @id @default(cuid())
  email     String       @unique
  password  String
  fullName  String?
  tenants   UserTenant[]
  invites   Invite[]
  passwordResetTokens   PasswordResetToken[]
  createdAt DateTime     @default(now())
}

model UserTenant {
  id       String @id @default(cuid())
  userId   String
  tenantId String
  role     Role   @default(USER)

  user   User   @relation(fields: [userId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([userId, tenantId]) // üî• ajoute √ßa
}

enum Role {
  OWNER
  ADMIN
  EDITOR
  VIEWER
  ENQUETEUR
  SUPERVISEUR
  USER
}

model Region {
  id           String        @id @default(cuid())
  tenantId     String
  name         String
  departements Departement[]
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  createdAt    DateTime      @default(now())

  @@unique([name, tenantId], name: "name_tenantId") // üî•
}

model Departement {
  id        String    @id @default(cuid())
  tenantId  String
  regionId  String
  name      String
  secteurs  Secteur[]
  region    Region    @relation(fields: [regionId], references: [id])
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  createdAt DateTime  @default(now())

  @@unique([name, regionId, tenantId], name: "name_regionId_tenantId")
}

model Secteur {
  id            String      @id @default(cuid())
  tenantId      String
  departementId String
  name          String
  villages      Village[]
  departement   Departement @relation(fields: [departementId], references: [id])
  tenant        Tenant      @relation(fields: [tenantId], references: [id])

  createdAt DateTime @default(now())

  @@unique([name, departementId, tenantId], name: "name_departementId_tenantId")
}

model Village {
  id        String   @id @default(cuid())
  tenantId  String
  secteurId String
  name      String
  secteur   Secteur  @relation(fields: [secteurId], references: [id])
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  createdAt DateTime @default(now())

  @@unique([name, secteurId, tenantId], name: "name_secteurId_tenantId")
}

model Survey {
  id        String     @id @default(cuid())
  tenantId  String
  title     String
  json      Json
  status    String
  responses Response[]
  tenant    Tenant     @relation(fields: [tenantId], references: [id])
}

model Response {
  id       String @id @default(cuid())
  surveyId String
  answers  Json
  meta     Json?
  survey   Survey @relation(fields: [surveyId], references: [id])
}

model Invite {
  id        String   @id @default(cuid())
  email     String
  tenantId  String
  role      Role     @default(USER)
  token     String   @unique
  accepted  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?  // ‚ö†Ô∏è √† la place de email
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
}
model PasswordResetToken {
  id        String   @id @default(cuid())
  tokenHash String   @unique
  userId    String
   tenantId  String
  expiresAt DateTime
  used      Boolean  @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
   tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([userId, tenantId])

  createdAt DateTime @default(now())
}

