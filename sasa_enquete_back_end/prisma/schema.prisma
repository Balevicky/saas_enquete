generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id                  String               @id @default(cuid())
  name                String
  slug                String               @unique
  logoUrl             String?
  settings            Json?
  invites             Invite[]
  surveys             Survey[]
  users               UserTenant[]
  // Relations inverses obligatoires
  regions             Region[]
  departements        Departement[]
  secteurs            Secteur[]
  villages            Village[]
  responses           Response[]
  respondents         Respondent[]
  questions           Question[]
  surveyResponses     SurveyResponse[]
  passwordResetTokens PasswordResetToken[]
  createdAt           DateTime             @default(now())
}

model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  password            String
  fullName            String?
  tenants             UserTenant[]
  invites             Invite[]
  passwordResetTokens PasswordResetToken[]
  createdAt           DateTime             @default(now())
  createdSurveys      Survey[]             @relation("SurveyCreator")
}

model UserTenant {
  id       String @id @default(cuid())
  userId   String
  tenantId String
  role     Role   @default(USER)

  user   User   @relation(fields: [userId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])

  @@unique([userId, tenantId]) // üî• ajoute √ßa
}

enum Role {
  OWNER
  ADMIN
  EDITOR
  VIEWER
  ENQUETEUR
  SUPERVISEUR
  USER
}

model Region {
  id           String        @id @default(cuid())
  tenantId     String
  name         String
  departements Departement[]
  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  createdAt    DateTime      @default(now())

  @@unique([name, tenantId], name: "name_tenantId") // üî•
}

model Departement {
  id        String    @id @default(cuid())
  tenantId  String
  regionId  String
  name      String
  secteurs  Secteur[]
  region    Region    @relation(fields: [regionId], references: [id])
  tenant    Tenant    @relation(fields: [tenantId], references: [id])
  createdAt DateTime  @default(now())

  @@unique([name, regionId, tenantId], name: "name_regionId_tenantId")
}

model Secteur {
  id            String      @id @default(cuid())
  tenantId      String
  departementId String
  name          String
  villages      Village[]
  departement   Departement @relation(fields: [departementId], references: [id])
  tenant        Tenant      @relation(fields: [tenantId], references: [id])

  createdAt DateTime @default(now())

  @@unique([name, departementId, tenantId], name: "name_departementId_tenantId")
}

model Village {
  id          String       @id @default(cuid())
  tenantId    String
  secteurId   String
  name        String
  secteur     Secteur      @relation(fields: [secteurId], references: [id])
  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  createdAt   DateTime     @default(now())
  respondents Respondent[]

  @@unique([name, secteurId, tenantId], name: "name_secteurId_tenantId")
}

model Survey {
  id          String           @id @default(cuid())
  title       String
  json        Json
  tenantId    String
  createdBy   String
  createdAt   DateTime         @default(now())
  respondents Respondent[]
  questions   Question[]
  creator     User             @relation("SurveyCreator", fields: [createdBy], references: [id])
  tenant      Tenant           @relation(fields: [tenantId], references: [id])
  responses   SurveyResponse[]
  status      SurveyStatus     @default(DRAFT)
  mode        SurveyMode       @default(SIMPLE)

  @@unique([id, tenantId])
  @@index([tenantId])
}

enum SurveyMode {
  SIMPLE
  ADVANCED
}

model SurveyResponse {
  id        String   @id @default(cuid())
  surveyId  String
  tenantId  String // üî• AJOUTER
  answers   Json
  meta      Json?
  createdAt DateTime @default(now())
  survey    Survey   @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([id, tenantId])
  @@index([tenantId, surveyId])
}

model Respondent {
  id          String    @id @default(cuid())
  surveyId    String
  name        String?
  firstname   String?
  birthYear   Int?
  villageId   String?
  externalId  String?
  tenantId    String
  startedAt   DateTime?
  completedAt DateTime?
  metadata    Json?
  survey      Survey    @relation(fields: [surveyId], references: [id], onDelete: Cascade)
  tenant      Tenant    @relation(fields: [tenantId], references: [id])

  village   Village?   @relation(fields: [villageId], references: [id])
  responses Response[]

  @@unique([id, tenantId])
  @@index([tenantId])
  @@index([villageId])
  @@index([completedAt])
  @@index([surveyId])
}

model Response {
  id           String     @id @default(cuid())
  respondentId String
  questionId   String
  tenantId     String
  answer       Json?
  respondent   Respondent @relation(fields: [respondentId], references: [id], onDelete: Cascade)
  tenant       Tenant     @relation(fields: [tenantId], references: [id])
  question     Question   @relation(fields: [questionId], references: [id])

  @@unique([respondentId, questionId, tenantId])
  @@unique([id, tenantId])
  @@index([tenantId, respondentId])
  @@index([questionId])
  @@index([tenantId, questionId])
}

model Question {
  id       String       @id @default(cuid())
  surveyId String
  tenantId String
  name      String
  label    String
  type     QuestionType
  position Int

options   Json?        // üëà Choix possibles (SINGLE / MULTIPLE)
  config    Json?        // üëà Param√®tres simples (SCALE, validations)
  nextMap   Json?        // üëà Condition SIMPLE (r√©ponse ‚Üí questionId)

  survey    Survey     @relation(fields: [surveyId], references: [id])
  tenant    Tenant     @relation(fields: [tenantId], references: [id])
  responses Response[]

  @@unique([id, tenantId])
  @@index([surveyId])
  @@unique([surveyId, name, tenantId])
  @@unique([surveyId, name])
}

enum QuestionType {
  NUMBER
  SCALE
  TEXT
  TEXTAREA
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  DATE
  EMAIL
  PHONE
}

enum SurveyStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Invite {
  id        String   @id @default(cuid())
  email     String
  tenantId  String
  role      Role     @default(USER)
  token     String   @unique
  accepted  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User?    @relation(fields: [userId], references: [id])
  userId    String? // ‚ö†Ô∏è √† la place de email
  tenant    Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([email, tenantId])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  tokenHash String   @unique
  userId    String
  tenantId  String
  expiresAt DateTime
  used      Boolean  @default(false)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([userId, tenantId])
}
